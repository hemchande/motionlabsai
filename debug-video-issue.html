<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Loading Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        video {
            width: 100%;
            max-width: 600px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Video Loading Debug Tool</h1>
        <p>Testing the exact video loading issue from the React app</p>
        
        <div class="debug-section">
            <h3>1. API Server Status</h3>
            <div id="apiStatus" class="status info">Checking API server...</div>
            <button class="test-button" onclick="checkApiServer()">Check API Server</button>
        </div>
        
        <div class="debug-section">
            <h3>2. Video URLs Test</h3>
            <div id="urlTestStatus" class="status info">Ready to test URLs</div>
            <button class="test-button" onclick="testAllUrls()">Test All Video URLs</button>
            <button class="test-button" onclick="testSpecificUrl('pdtyUo5UELk.mp4')">Test pdtyUo5UELk.mp4</button>
            <button class="test-button" onclick="testSpecificUrl('UgWHozR_LLA.mp4')">Test UgWHozR_LLA.mp4</button>
            <button class="test-button" onclick="testSpecificUrl('MeLfAr3GY6w.mp4')">Test MeLfAr3GY6w.mp4</button>
        </div>
        
        <div class="debug-section">
            <h3>3. Video Element Test (React-like)</h3>
            <div id="videoTestStatus" class="status info">Ready to test video element</div>
            <video id="testVideo" controls preload="metadata" crossOrigin="anonymous">
                <source src="http://localhost:5004/downloadPerFrameVideo?video_filename=pdtyUo5UELk.mp4" type="video/mp4">
                <source src="http://localhost:5004/downloadEnhancedReplay?video_filename=pdtyUo5UELk.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <button class="test-button" onclick="testVideoElement()">Test Video Element</button>
            <button class="test-button" onclick="changeVideoSource('pdtyUo5UELk.mp4')">Load pdtyUo5UELk.mp4</button>
            <button class="test-button" onclick="changeVideoSource('UgWHozR_LLA.mp4')">Load UgWHozR_LLA.mp4</button>
        </div>
        
        <div class="debug-section">
            <h3>4. CORS Test</h3>
            <div id="corsStatus" class="status info">Ready to test CORS</div>
            <button class="test-button" onclick="testCORS()">Test CORS Headers</button>
        </div>
        
        <div class="debug-section">
            <h3>5. Session Dashboard Simulation</h3>
            <div id="sessionStatus" class="status info">Ready to simulate Session Dashboard</div>
            <button class="test-button" onclick="simulateSessionDashboard()">Simulate Session Dashboard</button>
        </div>
        
        <div class="debug-section">
            <h3>6. Debug Log</h3>
            <div class="log-area" id="debugLog">Debug log will appear here...</div>
            <button class="test-button" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        const debugLog = document.getElementById('debugLog');
        const testVideo = document.getElementById('testVideo');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            debugLog.textContent = '';
        }
        
        // API Server Check
        async function checkApiServer() {
            log('üîç Checking API server...');
            const statusDiv = document.getElementById('apiStatus');
            
            try {
                const response = await fetch('http://localhost:5004/getProcessedVideos');
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API server is running. Found ${data.length} processed videos`);
                    statusDiv.textContent = `‚úÖ API server running - ${data.length} videos found`;
                    statusDiv.className = 'status success';
                    
                    // Log video details
                    data.forEach((video, index) => {
                        log(`  Video ${index + 1}: ${video.original_filename} (${video.analysis_type})`);
                    });
                } else {
                    log(`‚ùå API server responded with status: ${response.status}`);
                    statusDiv.textContent = `‚ùå API server error: ${response.status}`;
                    statusDiv.className = 'status error';
                }
            } catch (error) {
                log(`‚ùå API server check failed: ${error.message}`);
                statusDiv.textContent = `‚ùå API server not reachable: ${error.message}`;
                statusDiv.className = 'status error';
            }
        }
        
        // URL Testing
        async function testAllUrls() {
            log('üîç Testing all video URLs...');
            const statusDiv = document.getElementById('urlTestStatus');
            
            const testUrls = [
                'pdtyUo5UELk.mp4',
                'UgWHozR_LLA.mp4',
                'MeLfAr3GY6w.mp4'
            ];
            
            let successCount = 0;
            let totalCount = testUrls.length;
            
            for (const filename of testUrls) {
                const url = `http://localhost:5004/downloadPerFrameVideo?video_filename=${filename}`;
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (response.ok) {
                        log(`‚úÖ ${filename}: ${response.status} ${response.statusText}`);
                        successCount++;
                    } else {
                        log(`‚ùå ${filename}: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    log(`‚ùå ${filename}: ${error.message}`);
                }
            }
            
            if (successCount === totalCount) {
                statusDiv.textContent = `‚úÖ All URLs working (${successCount}/${totalCount})`;
                statusDiv.className = 'status success';
            } else {
                statusDiv.textContent = `‚ö†Ô∏è Some URLs failed (${successCount}/${totalCount})`;
                statusDiv.className = 'status warning';
            }
        }
        
        async function testSpecificUrl(filename) {
            log(`üîç Testing specific URL: ${filename}`);
            const url = `http://localhost:5004/downloadPerFrameVideo?video_filename=${filename}`;
            
            try {
                const response = await fetch(url, { method: 'HEAD' });
                log(`Response for ${filename}:`);
                log(`  Status: ${response.status} ${response.statusText}`);
                log(`  Content-Type: ${response.headers.get('Content-Type')}`);
                log(`  Content-Length: ${response.headers.get('Content-Length')}`);
                log(`  CORS: ${response.headers.get('Access-Control-Allow-Origin')}`);
            } catch (error) {
                log(`‚ùå Error testing ${filename}: ${error.message}`);
            }
        }
        
        // Video Element Testing
        function testVideoElement() {
            log('üîç Testing video element...');
            const statusDiv = document.getElementById('videoTestStatus');
            
            log(`Video element: ${testVideo}`);
            log(`Current src: ${testVideo.currentSrc}`);
            log(`Ready state: ${testVideo.readyState}`);
            log(`Network state: ${testVideo.networkState}`);
            log(`Error: ${testVideo.error}`);
            
            if (testVideo.error) {
                log(`Error code: ${testVideo.error.code}`);
                log(`Error message: ${testVideo.error.message}`);
                statusDiv.textContent = `‚ùå Video error: ${testVideo.error.message}`;
                statusDiv.className = 'status error';
            } else {
                statusDiv.textContent = '‚úÖ Video element ready';
                statusDiv.className = 'status success';
            }
        }
        
        function changeVideoSource(filename) {
            log(`üîÑ Changing video source to: ${filename}`);
            const url = `http://localhost:5004/downloadPerFrameVideo?video_filename=${filename}`;
            
            // Update sources
            const sources = testVideo.querySelectorAll('source');
            sources[0].src = url;
            sources[1].src = `http://localhost:5004/downloadEnhancedReplay?video_filename=${filename}`;
            
            // Reload video
            testVideo.load();
            log(`Video source changed to: ${url}`);
        }
        
        // CORS Testing
        async function testCORS() {
            log('üîç Testing CORS headers...');
            const statusDiv = document.getElementById('corsStatus');
            
            try {
                const response = await fetch('http://localhost:5004/downloadPerFrameVideo?video_filename=pdtyUo5UELk.mp4', {
                    method: 'OPTIONS'
                });
                
                log('CORS Headers:');
                log(`  Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}`);
                log(`  Access-Control-Allow-Methods: ${response.headers.get('Access-Control-Allow-Methods')}`);
                log(`  Access-Control-Allow-Headers: ${response.headers.get('Access-Control-Allow-Headers')}`);
                
                if (response.headers.get('Access-Control-Allow-Origin')) {
                    statusDiv.textContent = '‚úÖ CORS headers present';
                    statusDiv.className = 'status success';
                } else {
                    statusDiv.textContent = '‚ùå CORS headers missing';
                    statusDiv.className = 'status error';
                }
            } catch (error) {
                log(`‚ùå CORS test failed: ${error.message}`);
                statusDiv.textContent = `‚ùå CORS test failed: ${error.message}`;
                statusDiv.className = 'status error';
            }
        }
        
        // Session Dashboard Simulation
        async function simulateSessionDashboard() {
            log('üîç Simulating Session Dashboard...');
            const statusDiv = document.getElementById('sessionStatus');
            
            try {
                // Step 1: Get processed videos
                log('Step 1: Getting processed videos...');
                const videosResponse = await fetch('http://localhost:5004/getProcessedVideos');
                const videos = await videosResponse.json();
                
                // Step 2: Find a video with analytics
                const videoWithAnalytics = videos.find(v => v.has_analytics);
                if (!videoWithAnalytics) {
                    log('‚ùå No videos with analytics found');
                    statusDiv.textContent = '‚ùå No videos with analytics found';
                    statusDiv.className = 'status error';
                    return;
                }
                
                log(`Found video: ${videoWithAnalytics.original_filename}`);
                
                // Step 3: Construct video URL (like SessionDashboard does)
                let videoUrl;
                if (videoWithAnalytics.analysis_type === 'enhanced_replay') {
                    videoUrl = `http://localhost:5004/downloadEnhancedReplay?video_filename=${videoWithAnalytics.original_filename}`;
                } else if (videoWithAnalytics.analysis_type === 'api_generated') {
                    videoUrl = `http://localhost:5004/downloadPerFrameVideo?video_filename=${videoWithAnalytics.original_filename}`;
                } else {
                    videoUrl = `http://localhost:5004/downloadVideo?video_filename=${videoWithAnalytics.processed_filename}`;
                }
                
                log(`Constructed video URL: ${videoUrl}`);
                
                // Step 4: Test the URL
                const videoResponse = await fetch(videoUrl, { method: 'HEAD' });
                if (videoResponse.ok) {
                    log(`‚úÖ Video URL works: ${videoResponse.status}`);
                    statusDiv.textContent = `‚úÖ Session Dashboard simulation successful - ${videoWithAnalytics.original_filename}`;
                    statusDiv.className = 'status success';
                } else {
                    log(`‚ùå Video URL failed: ${videoResponse.status}`);
                    statusDiv.textContent = `‚ùå Video URL failed: ${videoResponse.status}`;
                    statusDiv.className = 'status error';
                }
                
            } catch (error) {
                log(`‚ùå Session Dashboard simulation failed: ${error.message}`);
                statusDiv.textContent = `‚ùå Simulation failed: ${error.message}`;
                statusDiv.className = 'status error';
            }
        }
        
        // Video event listeners for debugging
        testVideo.addEventListener('loadstart', () => {
            log('üé¨ Video loadstart event');
        });
        
        testVideo.addEventListener('loadedmetadata', () => {
            log(`üé¨ Video loadedmetadata - Duration: ${testVideo.duration}s`);
        });
        
        testVideo.addEventListener('canplay', () => {
            log('üé¨ Video canplay event');
        });
        
        testVideo.addEventListener('error', (e) => {
            log('üé¨ Video error event');
            log(`  Error: ${testVideo.error}`);
            log(`  Error code: ${testVideo.error?.code}`);
            log(`  Error message: ${testVideo.error?.message}`);
        });
        
        // Auto-run initial checks
        setTimeout(() => {
            log('üöÄ Starting initial checks...');
            checkApiServer();
        }, 1000);
    </script>
</body>
</html>















